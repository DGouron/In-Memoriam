"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var InMemoriam=function(){function e(){this.currentInfoWindows=null,this.eventHandlers={},this.heatMap=null,this.imgHousePath="./assets/images/corps/%house%.png",this.infoWindows=[],this.markerCluster=null,this.markers=[]}return e.prototype.init=function(){var e={center:new google.maps.LatLng(48.1,-4.21),mapTypeControl:!1,mapTypeId:google.maps.MapTypeId.HYBRID,maxZoom:15,streetViewControl:!1,zoom:12},t=document.getElementById("form-filters"),n=document.getElementById("map"),o=new google.maps.Map(n,e);this.bindAnchorEvents(o,n,t),this.bindFilters(o,n,t),this.bindLocalizationButton(o),this.bindMarkers(n.dataset.bloodbathSrc,o,this.getFilters(t,!0))},e.prototype.addEventHandler=function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on "+t,n)},e.prototype.removeEventHandler=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n,!1)},e.prototype.getFilterValueLabel=function(e,t){var n=document.querySelector('form select[name="'+e+'"] > option[value="'+t+'"]');return(n?n.innerText:t).replace(/\([\d]+\)/,"").trim()},e.prototype.filteredResponse=function(e,t){var n=e;for(var o in t)if(t.hasOwnProperty(o)){var r=o,a=t[o],i=a.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();if(a)for(var s=n.deaths.length;s--;)"search"===r&&a.length>=3?n.deaths[s].text.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().includes(i)||n.deaths[s].section.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().includes(i)||n.deaths[s].location.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().includes(i)||n.deaths.splice(s,1):n.deaths.hasOwnProperty(s)&&(!0!==n.deaths[s].published||n.deaths[s][r]&&n.deaths[s][r]!==a)&&n.deaths.splice(s,1)}return n},e.prototype.getFilters=function(e,t){var n=location.hash.substr(1).split("&"),o={},r={},a=document.querySelectorAll("form select, form input");return n.forEach(function(e){var t=e.split("=");2===t.length&&(o[t[0]]=t[1])}),a.forEach(function(e){t&&void 0!==o[e.id]?r[e.id]=o[e.id]:r[e.id]=e.value}),r},e.prototype.alterFiltersLabels=function(e){document.querySelectorAll("form select").forEach(function(t){var n=t.querySelectorAll("option");"true"===t.dataset.countable&&n.forEach(function(n){if(""!==n.value){for(var o in n.dataset.deathCount="0",e.deaths)if(e.deaths.hasOwnProperty(o)){var r=e.deaths[o];n.value===r[t.name]&&(n.dataset.deathCount=""+(+n.dataset.deathCount+r.count))}n.innerText=n.innerText.replace(/\([\d]+\)/,"")+" ("+n.dataset.deathCount+")"}})})},e.prototype.bindAnchorEvents=function(e,t,n){var o=this;window.addEventListener("hashchange",function(){o.bindFilters(e,t,n,!0),o.bindMarkers(t.dataset.bloodbathSrc,e,o.getFilters(n,!0))},!1)},e.prototype.bindFilters=function(e,t,n,o){var r=this,a=n.querySelectorAll("form select, form input");this.addEventHandler(n,"submit",function(e){e.preventDefault()}),a.forEach(function(a){var i=r.getFilters(n,o);a.value=void 0!==i[a.name]?i[a.name]:"","function"==typeof r.eventHandlers[a.id]&&r.removeEventHandler(a,"change",r.eventHandlers[a.id]),r.eventHandlers[a.id]=function(){var a=r.getFilters(n,o);return r.bindMarkers(t.dataset.bloodbathSrc,e,a),!1},o&&(a.value=void 0!==i[a.name]?i[a.name]:""),r.addEventHandler(a,"change",r.eventHandlers[a.id])})},e.prototype.clearMarkerCluster=function(){return this.markerCluster&&this.markerCluster.clearMarkers(),this},e.prototype.bindMarkers=function(e,t,n){var o=this;qwest.get(e.replace("%year%",n.year)+"?_="+(new Date).getTime()).then(function(e,r){var a=new google.maps.LatLngBounds,i=[],s=[],l=[],c=r;if(o.alterFiltersLabels(c),c=o.filteredResponse(c,n),o.clearMapObjects(),c.deaths&&c.deaths.length){var u=function(e){if(c.deaths.hasOwnProperty(e)){var n=c.deaths[e],r=o.imgHousePath.replace("%house%",n.house),a=new google.maps.Marker({map:t,icon:new google.maps.MarkerImage(r),position:new google.maps.LatLng(n.gps.lat,n.gps.lon),title:n.text}),u='\'<h4>\n              <img height="16" src="'+r+'" alt="House: '+n.house+'"  title="House: '+n.house+'" />\n              '+(n.section?n.section+" - ":"")+"\n              "+n.location+"\n              "+(n.count>1?' - <strong style="color: red;">'+n.count+" décès</strong>":"")+"\n            </h4>\n            <span>\n              <strong>Date</strong>: "+n.day+"/"+n.month+"/"+n.year+"\n              <br /><br />\n              <strong>Cause</strong>: "+o.getFilterValueLabel("cause",n.cause)+"\n              <br /><br />\n              <strong>Circonstances</strong>:  "+n.text+"\n            </span>";if(n.sources&&n.sources.length){var d="";for(var p in n.sources)if(n.sources.hasOwnProperty(p)){var h=n.sources[p];d+=(d?", ":"")+'<a href="'+h.url+'" target="_blank">'+h.titre+"</a>"}u+="<br /><br /><strong>Sources:</strong>"+d}u+='<br /><small style="float: right"><a href="mailto:contact@geolim4.com?subject='+("Erreur trouvée - "+n.section+" + -  "+n.day+"/"+n.month+"/"+n.year)+'">[Une erreur ?]</a></small>';var g=new google.maps.InfoWindow({content:u});google.maps.event.addListener(a,"click",function(){o.currentInfoWindows&&o.currentInfoWindows.close(),g.open(t,a),o.currentInfoWindows=g}),o.infoWindows.push(g),"interieur"===n.origin?l.push(a):i.push(a),s.push({location:new google.maps.LatLng(n.gps.lat,n.gps.lon),weight:10+(n.count>1?5*n.count:0)}),o.markers.push(a)}};for(var d in c.deaths)u(d);o.markerCluster=new MarkerClusterer(t,o.markers,{gridSize:60,imagePath:"./assets/images/clustering/m",maxZoom:14});var p=l.length?l:i;for(var d in p)p.hasOwnProperty(d)&&a.extend(p[d].getPosition());s.length&&(o.heatMap=new google.maps.visualization.HeatmapLayer({data:s,dissipating:!0,opacity:.3,radius:100}),o.heatMap.setMap(t)),o.buildPermalink(n),o.printDefinitionsText(r),t.fitBounds(a)}else o.printDefinitionsText(null)})},e.prototype.clearMapObjects=function(){this.clearMarkers().clearInfoWindows().clearHeatMap().clearMarkerCluster()},e.prototype.clearMarkers=function(){for(var e=0;e<this.markers.length;e++)this.markers[e].setMap(null);return this.markers=[],this},e.prototype.clearInfoWindows=function(){for(var e=0;e<this.clearInfoWindows.length;e++)this.clearInfoWindows[e].setMap(null);return this.infoWindows=[],this},e.prototype.clearHeatMap=function(){return this.heatMap&&this.heatMap.setMap(null),this},e.prototype.bindLocalizationButton=function(e){var t=this,n=document.createElement("div"),o=document.createElement("button"),r=new google.maps.Marker({map:e,animation:google.maps.Animation.DROP,icon:new google.maps.MarkerImage("./assets/images/map/bluedot.png"),position:{lat:31.4181,lng:73.0776}});o.style.backgroundColor="#FFF",o.style.border="none",o.style.borderRadius="2px",o.style.boxShadow="0 1px 4px rgba(0,0,0,0.3)",o.style.cursor="pointer",o.style.height="28px",o.style.marginRight="10px",o.style.outline="none",o.style.padding="0px",o.style.width="28px",o.title="Voir autour de moi",n.appendChild(o);var a=document.createElement("div");a.id="localizationImg",a.style.backgroundImage="url(https://maps.gstatic.com/tactile/mylocation/mylocation-sprite-1x.png)",a.style.backgroundPosition="0px 0px",a.style.backgroundRepeat="no-repeat",a.style.backgroundSize="180px 18px",a.style.height="18px",a.style.margin="5px",a.style.width="18px",o.appendChild(a),google.maps.event.addListener(e,"dragend",function(){document.querySelector("#localizationImg").style.backgroundPosition="0px 0px"}),o.addEventListener("click",function(){var n="0",o=setInterval(function(){var e=document.querySelector("#localizationImg");n=-18==+n?"0":"-18",e.style.backgroundPosition=n+"px 0px"},500);confirm("La demande de localisation ne servira qu'à positionner la carte autour de vous, aucune donnée ne sera envoyée ni même conservée nulle part.")&&navigator.geolocation?navigator.geolocation.getCurrentPosition(function(n){var a=new google.maps.LatLng(n.coords.latitude,n.coords.longitude);r.setPosition(a),e.setCenter(a),e.setZoom(13);var i=new google.maps.InfoWindow({content:"Ma position approximative"});google.maps.event.addListener(r,"click",function(){t.currentInfoWindows&&t.currentInfoWindows.close(),i.open(e,r),t.currentInfoWindows=i}),i.open(e,r),document.querySelector("#localizationImg").style.backgroundPosition="-144px 0px",clearInterval(o)}):(clearInterval(o),document.querySelector("#localizationImg").style.backgroundPosition="0px 0px")}),e.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(n)},e.prototype.getDefinitions=function(e){var t={};for(var n in e.definitions)if(e.definitions.hasOwnProperty(n))for(var o in e.deaths)if(e.deaths.hasOwnProperty(o)){var r=e.deaths[o];t[n]||(t[n]={}),t[n][r[n]]||(t[n][r[n]]=0),Number.isInteger(r.count)&&r.count>1?t[n][r[n]]+=r.count:t[n][r[n]]++}return t},e.prototype.printDefinitionsText=function(e){var t=[];if(e){var n=this.getDefinitions(e);for(var o in n)if(n.hasOwnProperty(o)){var r=n[o],a="";for(var i in r)if(r.hasOwnProperty(i)){var s=r[i],l=s>1;if(e.definitions[o][i])a+=(a?", ":"")+e.definitions[o][i][l?"plural":"singular"].replace("%d",s).replace("%"+o+"%'",i);else a+=(a?", ":"")+"["+i+"] ("+s+")"}t.push(e.definitions[o]["#label"].replace("%"+o+"%",a))}}else t.push("Aucun r&#233;sultat trouv&#233;");document.querySelector('[data-role="definitionsText"]').innerHTML=t.join("<br />")},e.prototype.buildPermalink=function(e){var t=document.querySelector('[data-role="permalink"]'),n=location.href.replace(/#.*$/,""),o="";for(var r in e)if(e.hasOwnProperty(r)){var a=e[r];a&&(o+=(o?"&":"#")+"{key}="+a)}t.value=n+o},e}();document.addEventListener("DOMContentLoaded",function(){(new InMemoriam).init()});